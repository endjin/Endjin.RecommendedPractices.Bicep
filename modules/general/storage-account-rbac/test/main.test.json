{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.8.9.13224",
      "templateHash": "2257433768409917575"
    }
  },
  "parameters": {
    "suffix": {
      "type": "string",
      "defaultValue": "[uniqueString(resourceGroup().id)]"
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2021-09-30-preview",
      "name": "[format('mi{0}', parameters('suffix'))]",
      "location": "[parameters('location')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "storageDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "name": {
            "value": "[format('storage{0}', parameters('suffix'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.8.9.13224",
              "templateHash": "5043884413033308242"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the storage account"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location of the storage account"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Standard_LRS",
              "metadata": {
                "description": "The SKU of the storage account"
              }
            },
            "kind": {
              "type": "string",
              "defaultValue": "StorageV2",
              "metadata": {
                "description": "The kind of the storage account"
              }
            },
            "tlsVersion": {
              "type": "string",
              "defaultValue": "TLS1_2",
              "metadata": {
                "description": "The minimum TLS version required by the storage account"
              }
            },
            "httpsOnly": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "When true, disables access to the storage account via unencrypted HTTP connections"
              }
            },
            "accessTier": {
              "type": "string",
              "defaultValue": "Hot",
              "metadata": {
                "description": "The access tier of the storage account"
              }
            },
            "isHnsEnabled": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "When true, enables Hierarchical Namespace feature, i.e. enabling Azure Data Lake Storage Gen2 capabilities"
              }
            },
            "networkAcls": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The optional network rules securing access to the storage account (ref: https://learn.microsoft.com/en-us/azure/templates/microsoft.storage/storageaccounts?pivots=deployment-language-bicep#networkruleset)"
              }
            },
            "saveAccessKeyToKeyVault": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "When true, the primary storage access key will be written to the specified key vault"
              }
            },
            "saveConnectionStringToKeyVault": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "When true, the default connection string using the primary storage access key will be written to the specified key vault"
              }
            },
            "keyVaultName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The name of the key vault used to store the access key"
              }
            },
            "keyVaultResourceGroupName": {
              "type": "string",
              "defaultValue": "[resourceGroup().name]",
              "metadata": {
                "description": "The resource group containing the key vault used to store the access key"
              }
            },
            "keyVaultSubscriptionId": {
              "type": "string",
              "defaultValue": "[subscription().subscriptionId]",
              "metadata": {
                "description": "The ID of the subscription containing the key vault used to store the access key"
              }
            },
            "keyVaultAccessKeySecretName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The key vault secret name used to store the access key"
              }
            },
            "keyVaultConnectionStringSecretName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The key vault secret name used to store the connection string"
              }
            },
            "useExisting": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "When true, the details of an existing storage account will be returned; When false, the storage account is created/updated"
              }
            },
            "resource_tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The resource tags applied to resources"
              }
            }
          },
          "resources": [
            {
              "condition": "[not(parameters('useExisting'))]",
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-06-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[parameters('sku')]"
              },
              "kind": "[parameters('kind')]",
              "properties": {
                "minimumTlsVersion": "[parameters('tlsVersion')]",
                "supportsHttpsTrafficOnly": "[parameters('httpsOnly')]",
                "accessTier": "[parameters('accessTier')]",
                "isHnsEnabled": "[parameters('isHnsEnabled')]",
                "networkAcls": "[parameters('networkAcls')]"
              },
              "tags": "[parameters('resource_tags')]"
            },
            {
              "condition": "[parameters('saveAccessKeyToKeyVault')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('storageAccessKeySecretDeploy{0}', parameters('name'))]",
              "subscriptionId": "[parameters('keyVaultSubscriptionId')]",
              "resourceGroup": "[parameters('keyVaultResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultName": {
                    "value": "[parameters('keyVaultName')]"
                  },
                  "secretName": {
                    "value": "[parameters('keyVaultAccessKeySecretName')]"
                  },
                  "contentValue": {
                    "value": "[if(parameters('useExisting'), listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '2021-06-01').keys[0].value, listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '2021-06-01').keys[0].value)]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.8.9.13224",
                      "templateHash": "12015994460177070841"
                    }
                  },
                  "parameters": {
                    "secretName": {
                      "type": "string",
                      "metadata": {
                        "description": "Enter the secret name."
                      }
                    },
                    "contentType": {
                      "type": "string",
                      "defaultValue": "text/plain",
                      "metadata": {
                        "description": "Type of the secret"
                      }
                    },
                    "contentValue": {
                      "type": "secureString",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Value of the secret"
                      }
                    },
                    "keyVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the vault"
                      }
                    },
                    "useExisting": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "When true, a pre-existing secret will be returned"
                      }
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(parameters('useExisting'))]",
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2021-06-01-preview",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
                      "properties": {
                        "contentType": "[parameters('contentType')]",
                        "value": "[parameters('contentValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "secretUriWithVersion": {
                      "type": "string",
                      "value": "[if(parameters('useExisting'), reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretName')), '2021-06-01-preview').secretUriWithVersion, reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretName')), '2021-06-01-preview').secretUriWithVersion)]",
                      "metadata": {
                        "description": "The key vault URI linking to the new/updated secret"
                      }
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
              ]
            },
            {
              "condition": "[parameters('saveConnectionStringToKeyVault')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('storageConnectionStringSecretDeploy{0}', parameters('name'))]",
              "subscriptionId": "[parameters('keyVaultSubscriptionId')]",
              "resourceGroup": "[parameters('keyVaultResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultName": {
                    "value": "[parameters('keyVaultName')]"
                  },
                  "secretName": {
                    "value": "[parameters('keyVaultConnectionStringSecretName')]"
                  },
                  "contentValue": {
                    "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', parameters('name'), environment().suffixes.storage, if(parameters('useExisting'), listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '2021-06-01').keys[0].value, listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '2021-06-01').keys[0].value))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.8.9.13224",
                      "templateHash": "12015994460177070841"
                    }
                  },
                  "parameters": {
                    "secretName": {
                      "type": "string",
                      "metadata": {
                        "description": "Enter the secret name."
                      }
                    },
                    "contentType": {
                      "type": "string",
                      "defaultValue": "text/plain",
                      "metadata": {
                        "description": "Type of the secret"
                      }
                    },
                    "contentValue": {
                      "type": "secureString",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Value of the secret"
                      }
                    },
                    "keyVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the vault"
                      }
                    },
                    "useExisting": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "When true, a pre-existing secret will be returned"
                      }
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(parameters('useExisting'))]",
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2021-06-01-preview",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
                      "properties": {
                        "contentType": "[parameters('contentType')]",
                        "value": "[parameters('contentValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "secretUriWithVersion": {
                      "type": "string",
                      "value": "[if(parameters('useExisting'), reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretName')), '2021-06-01-preview').secretUriWithVersion, reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretName')), '2021-06-01-preview').secretUriWithVersion)]",
                      "metadata": {
                        "description": "The key vault URI linking to the new/updated secret"
                      }
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[if(parameters('useExisting'), resourceId('Microsoft.Storage/storageAccounts', parameters('name')), resourceId('Microsoft.Storage/storageAccounts', parameters('name')))]",
              "metadata": {
                "description": "The resource ID of the storage account"
              }
            },
            "name": {
              "type": "string",
              "value": "[if(parameters('useExisting'), parameters('name'), parameters('name'))]",
              "metadata": {
                "description": "The name of the storage account"
              }
            },
            "storageAccountResource": {
              "type": "object",
              "value": "[if(parameters('useExisting'), reference(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '2021-06-01', 'full'), reference(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '2021-06-01', 'full'))]",
              "metadata": {
                "description": "An object representing the storage account resource"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "rbacOwner",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "assigneeObjectId": {
            "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('mi{0}', parameters('suffix')))).principalId]"
          },
          "principalType": {
            "value": "ServicePrincipal"
          },
          "role": {
            "value": "Owner"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageDeploy')).outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.8.9.13224",
              "templateHash": "16222554879906653387"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the storage account to apply the role assignement."
              }
            },
            "role": {
              "type": "string",
              "metadata": {
                "description": "The name of the role to grant the assignee on the storage account. See: https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles"
              },
              "allowedValues": [
                "Owner",
                "Contributor",
                "Reader",
                "Storage Blob Data Owner",
                "Storage Blob Data Contributor",
                "Storage Blob Data Reader"
              ]
            },
            "assigneeObjectId": {
              "type": "string",
              "metadata": {
                "description": "The object ID of the assignee Azure AD group / service principal / user."
              }
            },
            "principalType": {
              "type": "string",
              "metadata": {
                "description": "The assignee's type of Azure AD principal."
              },
              "allowedValues": [
                "Group",
                "ServicePrincipal",
                "User"
              ]
            },
            "roleAssignmentId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "A GUID to use as the role assignment resource name, if omitted, one will be generated based on the storage account, role and assignee"
              }
            }
          },
          "variables": {
            "roles": {
              "Owner": "[resourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
              "Reader": "[resourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
              "Contributor": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
              "Storage Blob Data Owner": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b')]",
              "Storage Blob Data Contributor": "[resourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
              "Storage Blob Data Reader": "[resourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]"
            },
            "storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
            "generatedRoleAssignmentId": "[guid(format('{0}{1}{2}', variables('storageAccountId'), variables('roles')[parameters('role')], parameters('assigneeObjectId')))]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[if(empty(parameters('roleAssignmentId')), variables('generatedRoleAssignmentId'), parameters('roleAssignmentId'))]",
              "properties": {
                "roleDefinitionId": "[variables('roles')[parameters('role')]]",
                "principalId": "[parameters('assigneeObjectId')]",
                "principalType": "[parameters('principalType')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), 'Microsoft.Authorization/roleAssignments', if(empty(parameters('roleAssignmentId')), variables('generatedRoleAssignmentId'), parameters('roleAssignmentId')))]",
              "metadata": {
                "description": "The resource ID of the role assignement."
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('mi{0}', parameters('suffix')))]",
        "[resourceId('Microsoft.Resources/deployments', 'storageDeploy')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "rbacContributor",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "assigneeObjectId": {
            "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('mi{0}', parameters('suffix')))).principalId]"
          },
          "principalType": {
            "value": "ServicePrincipal"
          },
          "role": {
            "value": "Contributor"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageDeploy')).outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.8.9.13224",
              "templateHash": "16222554879906653387"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the storage account to apply the role assignement."
              }
            },
            "role": {
              "type": "string",
              "metadata": {
                "description": "The name of the role to grant the assignee on the storage account. See: https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles"
              },
              "allowedValues": [
                "Owner",
                "Contributor",
                "Reader",
                "Storage Blob Data Owner",
                "Storage Blob Data Contributor",
                "Storage Blob Data Reader"
              ]
            },
            "assigneeObjectId": {
              "type": "string",
              "metadata": {
                "description": "The object ID of the assignee Azure AD group / service principal / user."
              }
            },
            "principalType": {
              "type": "string",
              "metadata": {
                "description": "The assignee's type of Azure AD principal."
              },
              "allowedValues": [
                "Group",
                "ServicePrincipal",
                "User"
              ]
            },
            "roleAssignmentId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "A GUID to use as the role assignment resource name, if omitted, one will be generated based on the storage account, role and assignee"
              }
            }
          },
          "variables": {
            "roles": {
              "Owner": "[resourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
              "Reader": "[resourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
              "Contributor": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
              "Storage Blob Data Owner": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b')]",
              "Storage Blob Data Contributor": "[resourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
              "Storage Blob Data Reader": "[resourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]"
            },
            "storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
            "generatedRoleAssignmentId": "[guid(format('{0}{1}{2}', variables('storageAccountId'), variables('roles')[parameters('role')], parameters('assigneeObjectId')))]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[if(empty(parameters('roleAssignmentId')), variables('generatedRoleAssignmentId'), parameters('roleAssignmentId'))]",
              "properties": {
                "roleDefinitionId": "[variables('roles')[parameters('role')]]",
                "principalId": "[parameters('assigneeObjectId')]",
                "principalType": "[parameters('principalType')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), 'Microsoft.Authorization/roleAssignments', if(empty(parameters('roleAssignmentId')), variables('generatedRoleAssignmentId'), parameters('roleAssignmentId')))]",
              "metadata": {
                "description": "The resource ID of the role assignement."
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('mi{0}', parameters('suffix')))]",
        "[resourceId('Microsoft.Resources/deployments', 'storageDeploy')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "rbacReader",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "assigneeObjectId": {
            "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('mi{0}', parameters('suffix')))).principalId]"
          },
          "principalType": {
            "value": "ServicePrincipal"
          },
          "role": {
            "value": "Reader"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageDeploy')).outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.8.9.13224",
              "templateHash": "16222554879906653387"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the storage account to apply the role assignement."
              }
            },
            "role": {
              "type": "string",
              "metadata": {
                "description": "The name of the role to grant the assignee on the storage account. See: https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles"
              },
              "allowedValues": [
                "Owner",
                "Contributor",
                "Reader",
                "Storage Blob Data Owner",
                "Storage Blob Data Contributor",
                "Storage Blob Data Reader"
              ]
            },
            "assigneeObjectId": {
              "type": "string",
              "metadata": {
                "description": "The object ID of the assignee Azure AD group / service principal / user."
              }
            },
            "principalType": {
              "type": "string",
              "metadata": {
                "description": "The assignee's type of Azure AD principal."
              },
              "allowedValues": [
                "Group",
                "ServicePrincipal",
                "User"
              ]
            },
            "roleAssignmentId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "A GUID to use as the role assignment resource name, if omitted, one will be generated based on the storage account, role and assignee"
              }
            }
          },
          "variables": {
            "roles": {
              "Owner": "[resourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
              "Reader": "[resourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
              "Contributor": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
              "Storage Blob Data Owner": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b')]",
              "Storage Blob Data Contributor": "[resourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
              "Storage Blob Data Reader": "[resourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]"
            },
            "storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
            "generatedRoleAssignmentId": "[guid(format('{0}{1}{2}', variables('storageAccountId'), variables('roles')[parameters('role')], parameters('assigneeObjectId')))]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[if(empty(parameters('roleAssignmentId')), variables('generatedRoleAssignmentId'), parameters('roleAssignmentId'))]",
              "properties": {
                "roleDefinitionId": "[variables('roles')[parameters('role')]]",
                "principalId": "[parameters('assigneeObjectId')]",
                "principalType": "[parameters('principalType')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), 'Microsoft.Authorization/roleAssignments', if(empty(parameters('roleAssignmentId')), variables('generatedRoleAssignmentId'), parameters('roleAssignmentId')))]",
              "metadata": {
                "description": "The resource ID of the role assignement."
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('mi{0}', parameters('suffix')))]",
        "[resourceId('Microsoft.Resources/deployments', 'storageDeploy')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "rbacSbdOwner",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "assigneeObjectId": {
            "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('mi{0}', parameters('suffix')))).principalId]"
          },
          "principalType": {
            "value": "ServicePrincipal"
          },
          "role": {
            "value": "Storage Blob Data Owner"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageDeploy')).outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.8.9.13224",
              "templateHash": "16222554879906653387"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the storage account to apply the role assignement."
              }
            },
            "role": {
              "type": "string",
              "metadata": {
                "description": "The name of the role to grant the assignee on the storage account. See: https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles"
              },
              "allowedValues": [
                "Owner",
                "Contributor",
                "Reader",
                "Storage Blob Data Owner",
                "Storage Blob Data Contributor",
                "Storage Blob Data Reader"
              ]
            },
            "assigneeObjectId": {
              "type": "string",
              "metadata": {
                "description": "The object ID of the assignee Azure AD group / service principal / user."
              }
            },
            "principalType": {
              "type": "string",
              "metadata": {
                "description": "The assignee's type of Azure AD principal."
              },
              "allowedValues": [
                "Group",
                "ServicePrincipal",
                "User"
              ]
            },
            "roleAssignmentId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "A GUID to use as the role assignment resource name, if omitted, one will be generated based on the storage account, role and assignee"
              }
            }
          },
          "variables": {
            "roles": {
              "Owner": "[resourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
              "Reader": "[resourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
              "Contributor": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
              "Storage Blob Data Owner": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b')]",
              "Storage Blob Data Contributor": "[resourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
              "Storage Blob Data Reader": "[resourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]"
            },
            "storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
            "generatedRoleAssignmentId": "[guid(format('{0}{1}{2}', variables('storageAccountId'), variables('roles')[parameters('role')], parameters('assigneeObjectId')))]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[if(empty(parameters('roleAssignmentId')), variables('generatedRoleAssignmentId'), parameters('roleAssignmentId'))]",
              "properties": {
                "roleDefinitionId": "[variables('roles')[parameters('role')]]",
                "principalId": "[parameters('assigneeObjectId')]",
                "principalType": "[parameters('principalType')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), 'Microsoft.Authorization/roleAssignments', if(empty(parameters('roleAssignmentId')), variables('generatedRoleAssignmentId'), parameters('roleAssignmentId')))]",
              "metadata": {
                "description": "The resource ID of the role assignement."
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('mi{0}', parameters('suffix')))]",
        "[resourceId('Microsoft.Resources/deployments', 'storageDeploy')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "rbacSbdContributor",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "assigneeObjectId": {
            "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('mi{0}', parameters('suffix')))).principalId]"
          },
          "principalType": {
            "value": "ServicePrincipal"
          },
          "role": {
            "value": "Storage Blob Data Contributor"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageDeploy')).outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.8.9.13224",
              "templateHash": "16222554879906653387"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the storage account to apply the role assignement."
              }
            },
            "role": {
              "type": "string",
              "metadata": {
                "description": "The name of the role to grant the assignee on the storage account. See: https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles"
              },
              "allowedValues": [
                "Owner",
                "Contributor",
                "Reader",
                "Storage Blob Data Owner",
                "Storage Blob Data Contributor",
                "Storage Blob Data Reader"
              ]
            },
            "assigneeObjectId": {
              "type": "string",
              "metadata": {
                "description": "The object ID of the assignee Azure AD group / service principal / user."
              }
            },
            "principalType": {
              "type": "string",
              "metadata": {
                "description": "The assignee's type of Azure AD principal."
              },
              "allowedValues": [
                "Group",
                "ServicePrincipal",
                "User"
              ]
            },
            "roleAssignmentId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "A GUID to use as the role assignment resource name, if omitted, one will be generated based on the storage account, role and assignee"
              }
            }
          },
          "variables": {
            "roles": {
              "Owner": "[resourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
              "Reader": "[resourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
              "Contributor": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
              "Storage Blob Data Owner": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b')]",
              "Storage Blob Data Contributor": "[resourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
              "Storage Blob Data Reader": "[resourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]"
            },
            "storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
            "generatedRoleAssignmentId": "[guid(format('{0}{1}{2}', variables('storageAccountId'), variables('roles')[parameters('role')], parameters('assigneeObjectId')))]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[if(empty(parameters('roleAssignmentId')), variables('generatedRoleAssignmentId'), parameters('roleAssignmentId'))]",
              "properties": {
                "roleDefinitionId": "[variables('roles')[parameters('role')]]",
                "principalId": "[parameters('assigneeObjectId')]",
                "principalType": "[parameters('principalType')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), 'Microsoft.Authorization/roleAssignments', if(empty(parameters('roleAssignmentId')), variables('generatedRoleAssignmentId'), parameters('roleAssignmentId')))]",
              "metadata": {
                "description": "The resource ID of the role assignement."
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('mi{0}', parameters('suffix')))]",
        "[resourceId('Microsoft.Resources/deployments', 'storageDeploy')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "rbacSbdReader",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "assigneeObjectId": {
            "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('mi{0}', parameters('suffix')))).principalId]"
          },
          "principalType": {
            "value": "ServicePrincipal"
          },
          "role": {
            "value": "Storage Blob Data Reader"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageDeploy')).outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.8.9.13224",
              "templateHash": "16222554879906653387"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the storage account to apply the role assignement."
              }
            },
            "role": {
              "type": "string",
              "metadata": {
                "description": "The name of the role to grant the assignee on the storage account. See: https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles"
              },
              "allowedValues": [
                "Owner",
                "Contributor",
                "Reader",
                "Storage Blob Data Owner",
                "Storage Blob Data Contributor",
                "Storage Blob Data Reader"
              ]
            },
            "assigneeObjectId": {
              "type": "string",
              "metadata": {
                "description": "The object ID of the assignee Azure AD group / service principal / user."
              }
            },
            "principalType": {
              "type": "string",
              "metadata": {
                "description": "The assignee's type of Azure AD principal."
              },
              "allowedValues": [
                "Group",
                "ServicePrincipal",
                "User"
              ]
            },
            "roleAssignmentId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "A GUID to use as the role assignment resource name, if omitted, one will be generated based on the storage account, role and assignee"
              }
            }
          },
          "variables": {
            "roles": {
              "Owner": "[resourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
              "Reader": "[resourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
              "Contributor": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
              "Storage Blob Data Owner": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b')]",
              "Storage Blob Data Contributor": "[resourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
              "Storage Blob Data Reader": "[resourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]"
            },
            "storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
            "generatedRoleAssignmentId": "[guid(format('{0}{1}{2}', variables('storageAccountId'), variables('roles')[parameters('role')], parameters('assigneeObjectId')))]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[if(empty(parameters('roleAssignmentId')), variables('generatedRoleAssignmentId'), parameters('roleAssignmentId'))]",
              "properties": {
                "roleDefinitionId": "[variables('roles')[parameters('role')]]",
                "principalId": "[parameters('assigneeObjectId')]",
                "principalType": "[parameters('principalType')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), 'Microsoft.Authorization/roleAssignments', if(empty(parameters('roleAssignmentId')), variables('generatedRoleAssignmentId'), parameters('roleAssignmentId')))]",
              "metadata": {
                "description": "The resource ID of the role assignement."
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('mi{0}', parameters('suffix')))]",
        "[resourceId('Microsoft.Resources/deployments', 'storageDeploy')]"
      ]
    }
  ]
}