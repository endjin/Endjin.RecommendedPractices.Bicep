{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.31.92.45157",
      "templateHash": "6856080117955085839"
    },
    "name": "acs-email-managed-domain-with-published-config",
    "description": "Azure Communication Email Service with managed Azure domain, with published configuration",
    "owner": "endjin"
  },
  "parameters": {
    "communicationServiceName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Azure Communication Service resource."
      }
    },
    "emailServiceName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Email Communication Service resource."
      }
    },
    "dataLocation": {
      "type": "string",
      "allowedValues": [
        "Africa",
        "Asia Pacific",
        "Australia",
        "Brazil",
        "Canada",
        "Europe",
        "France",
        "Germany",
        "India",
        "Japan",
        "Korea",
        "Norway",
        "Switzerland",
        "United Arab Emirates",
        "UK",
        "United States"
      ],
      "metadata": {
        "description": "The location where the communication and email service stores its data at rest."
      }
    },
    "senderUsername": {
      "type": "string",
      "defaultValue": "DoNotReply",
      "metadata": {
        "description": "The username for the sender email address. Defaults to \"DoNotReply\"."
      }
    },
    "keyVaultName": {
      "type": "string",
      "metadata": {
        "description": "The name of the key vault where the configuration will be published"
      }
    },
    "keyVaultResourceGroupName": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "The resource group of the key vault where the configuration will be published"
      }
    },
    "keyVaultSubscriptionId": {
      "type": "string",
      "defaultValue": "[subscription().subscriptionId]",
      "metadata": {
        "description": "The subscription of the key vault where the configuration will be published"
      }
    },
    "enableDiagnostics": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "If true, enable diagnostics on the workspace (`logAnalyticsWorkspaceId` must also be set)."
      }
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "When `enableDiagnostics` is true, the workspace ID (resource ID of a Log Analytics workspace) for a Log Analytics workspace to which you would like to send Diagnostic Logs."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "AcsEmailDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "communicationServiceName": {
            "value": "[parameters('communicationServiceName')]"
          },
          "dataLocation": {
            "value": "[parameters('dataLocation')]"
          },
          "emailServiceName": {
            "value": "[parameters('emailServiceName')]"
          },
          "senderUsername": {
            "value": "[parameters('senderUsername')]"
          },
          "enableDiagnostics": {
            "value": "[parameters('enableDiagnostics')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[parameters('logAnalyticsWorkspaceId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.31.92.45157",
              "templateHash": "17954315896780719481"
            },
            "name": "acs-email-managed-domain",
            "description": "Azure Communication Email Service with managed Azure domain",
            "owner": "endjin"
          },
          "parameters": {
            "communicationServiceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Azure Communication Service resource."
              }
            },
            "emailServiceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Email Communication Service resource."
              }
            },
            "dataLocation": {
              "type": "string",
              "allowedValues": [
                "Africa",
                "Asia Pacific",
                "Australia",
                "Brazil",
                "Canada",
                "Europe",
                "France",
                "Germany",
                "India",
                "Japan",
                "Korea",
                "Norway",
                "Switzerland",
                "United Arab Emirates",
                "UK",
                "United States"
              ],
              "metadata": {
                "description": "The location where the communication and email service stores its data at rest."
              }
            },
            "senderUsername": {
              "type": "string",
              "defaultValue": "DoNotReply",
              "metadata": {
                "description": "The username for the sender email address. Defaults to \"DoNotReply\"."
              }
            },
            "enableDiagnostics": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "If true, enable diagnostics on the workspace (`logAnalyticsWorkspaceId` must also be set)."
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "When `enableDiagnostics` is true, the workspace ID (resource ID of a Log Analytics workspace) for a Log Analytics workspace to which you would like to send Diagnostic Logs."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Communication/emailServices/domains/senderUsernames",
              "apiVersion": "2023-04-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('emailServiceName'), 'AzureManagedDomain', parameters('senderUsername'))]",
              "properties": {
                "username": "[parameters('senderUsername')]",
                "displayName": "[parameters('senderUsername')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Communication/emailServices/domains', parameters('emailServiceName'), 'AzureManagedDomain')]"
              ]
            },
            {
              "type": "Microsoft.Communication/emailServices/domains",
              "apiVersion": "2023-04-01-preview",
              "name": "[format('{0}/{1}', parameters('emailServiceName'), 'AzureManagedDomain')]",
              "location": "global",
              "properties": {
                "domainManagement": "AzureManaged",
                "userEngagementTracking": "Disabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Communication/emailServices', parameters('emailServiceName'))]"
              ]
            },
            {
              "type": "Microsoft.Communication/communicationServices",
              "apiVersion": "2023-04-01-preview",
              "name": "[parameters('communicationServiceName')]",
              "location": "global",
              "properties": {
                "dataLocation": "[parameters('dataLocation')]",
                "linkedDomains": [
                  "[resourceId('Microsoft.Communication/emailServices/domains', parameters('emailServiceName'), 'AzureManagedDomain')]"
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Communication/emailServices/domains', parameters('emailServiceName'), 'AzureManagedDomain')]"
              ]
            },
            {
              "type": "Microsoft.Communication/emailServices",
              "apiVersion": "2023-04-01-preview",
              "name": "[parameters('emailServiceName')]",
              "location": "global",
              "properties": {
                "dataLocation": "[parameters('dataLocation')]"
              }
            },
            {
              "condition": "[parameters('enableDiagnostics')]",
              "type": "microsoft.insights/diagnosticSettings",
              "apiVersion": "2016-09-01",
              "scope": "[format('Microsoft.Communication/communicationServices/{0}', parameters('communicationServiceName'))]",
              "name": "service",
              "location": "[parameters('dataLocation')]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "category": "EmailSendMailOperational",
                    "enabled": true
                  },
                  {
                    "category": "EmailStatusUpdateOperational",
                    "enabled": true
                  },
                  {
                    "category": "EmailUserEngagementOperational",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Communication/communicationServices', parameters('communicationServiceName'))]"
              ]
            }
          ],
          "outputs": {
            "domain": {
              "type": "string",
              "metadata": {
                "description": "The Azure managed domain."
              },
              "value": "[reference(resourceId('Microsoft.Communication/emailServices/domains', parameters('emailServiceName'), 'AzureManagedDomain'), '2023-04-01-preview').mailFromSenderDomain]"
            },
            "sendFromEmailAddress": {
              "type": "string",
              "metadata": {
                "description": "The send-from email address for the Azure managed domain."
              },
              "value": "[format('{0}@{1}', reference(resourceId('Microsoft.Communication/emailServices/domains/senderUsernames', parameters('emailServiceName'), 'AzureManagedDomain', parameters('senderUsername')), '2023-04-01-preview').username, reference(resourceId('Microsoft.Communication/emailServices/domains', parameters('emailServiceName'), 'AzureManagedDomain'), '2023-04-01-preview').mailFromSenderDomain)]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "acsEmailSetSecretsDeploy",
      "subscriptionId": "[parameters('keyVaultSubscriptionId')]",
      "resourceGroup": "[parameters('keyVaultResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "communicationServiceName": {
            "value": "[parameters('communicationServiceName')]"
          },
          "domain": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'AcsEmailDeploy'), '2022-09-01').outputs.domain.value]"
          },
          "sendFromEmailAddress": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'AcsEmailDeploy'), '2022-09-01').outputs.sendFromEmailAddress.value]"
          },
          "communicationServiceResourceGroupName": {
            "value": "[resourceGroup().name]"
          },
          "communicationServiceSubscriptionId": {
            "value": "[subscription().subscriptionId]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.31.92.45157",
              "templateHash": "11942593376721878443"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string"
            },
            "communicationServiceName": {
              "type": "string"
            },
            "domain": {
              "type": "string"
            },
            "sendFromEmailAddress": {
              "type": "string"
            },
            "communicationServiceResourceGroupName": {
              "type": "string"
            },
            "communicationServiceSubscriptionId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "communicationServiceKeySecretDeploy",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultName": {
                    "value": "[parameters('keyVaultName')]"
                  },
                  "secretName": {
                    "value": "CommunicationServiceKey"
                  },
                  "contentValue": {
                    "value": "[listKeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('communicationServiceSubscriptionId'), parameters('communicationServiceResourceGroupName')), 'Microsoft.Communication/communicationServices', parameters('communicationServiceName')), '2023-04-01-preview').primaryKey]"
                  },
                  "contentType": {
                    "value": "text/plain"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.31.92.45157",
                      "templateHash": "7647943469143824631"
                    },
                    "name": "Adds or updates a Key Vault secret",
                    "description": "Adds or updates a Key Vault secret",
                    "owner": "endjin"
                  },
                  "parameters": {
                    "secretName": {
                      "type": "string",
                      "metadata": {
                        "description": "Enter the secret name."
                      }
                    },
                    "contentType": {
                      "type": "string",
                      "defaultValue": "text/plain",
                      "metadata": {
                        "description": "Type of the secret"
                      }
                    },
                    "contentValue": {
                      "type": "securestring",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Value of the secret"
                      }
                    },
                    "keyVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the vault"
                      }
                    },
                    "useExisting": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "When true, a pre-existing secret will be returned"
                      }
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(parameters('useExisting'))]",
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2021-06-01-preview",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
                      "properties": {
                        "contentType": "[parameters('contentType')]",
                        "value": "[parameters('contentValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "secretUriWithVersion": {
                      "type": "string",
                      "metadata": {
                        "description": "The key vault URI linking to the new/updated secret"
                      },
                      "value": "[if(parameters('useExisting'), reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretName')), '2021-06-01-preview').secretUriWithVersion, reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretName')), '2021-06-01-preview').secretUriWithVersion)]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "communicationServiceConnectionStringSecretDeploy",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultName": {
                    "value": "[parameters('keyVaultName')]"
                  },
                  "secretName": {
                    "value": "CommunicationServiceConnectionString"
                  },
                  "contentValue": {
                    "value": "[listKeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('communicationServiceSubscriptionId'), parameters('communicationServiceResourceGroupName')), 'Microsoft.Communication/communicationServices', parameters('communicationServiceName')), '2023-04-01-preview').primaryConnectionString]"
                  },
                  "contentType": {
                    "value": "text/plain"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.31.92.45157",
                      "templateHash": "7647943469143824631"
                    },
                    "name": "Adds or updates a Key Vault secret",
                    "description": "Adds or updates a Key Vault secret",
                    "owner": "endjin"
                  },
                  "parameters": {
                    "secretName": {
                      "type": "string",
                      "metadata": {
                        "description": "Enter the secret name."
                      }
                    },
                    "contentType": {
                      "type": "string",
                      "defaultValue": "text/plain",
                      "metadata": {
                        "description": "Type of the secret"
                      }
                    },
                    "contentValue": {
                      "type": "securestring",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Value of the secret"
                      }
                    },
                    "keyVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the vault"
                      }
                    },
                    "useExisting": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "When true, a pre-existing secret will be returned"
                      }
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(parameters('useExisting'))]",
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2021-06-01-preview",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
                      "properties": {
                        "contentType": "[parameters('contentType')]",
                        "value": "[parameters('contentValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "secretUriWithVersion": {
                      "type": "string",
                      "metadata": {
                        "description": "The key vault URI linking to the new/updated secret"
                      },
                      "value": "[if(parameters('useExisting'), reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretName')), '2021-06-01-preview').secretUriWithVersion, reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretName')), '2021-06-01-preview').secretUriWithVersion)]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "emailServiceDomainSecretDeploy",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultName": {
                    "value": "[parameters('keyVaultName')]"
                  },
                  "secretName": {
                    "value": "EmailServiceDomain"
                  },
                  "contentValue": {
                    "value": "[parameters('domain')]"
                  },
                  "contentType": {
                    "value": "text/plain"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.31.92.45157",
                      "templateHash": "7647943469143824631"
                    },
                    "name": "Adds or updates a Key Vault secret",
                    "description": "Adds or updates a Key Vault secret",
                    "owner": "endjin"
                  },
                  "parameters": {
                    "secretName": {
                      "type": "string",
                      "metadata": {
                        "description": "Enter the secret name."
                      }
                    },
                    "contentType": {
                      "type": "string",
                      "defaultValue": "text/plain",
                      "metadata": {
                        "description": "Type of the secret"
                      }
                    },
                    "contentValue": {
                      "type": "securestring",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Value of the secret"
                      }
                    },
                    "keyVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the vault"
                      }
                    },
                    "useExisting": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "When true, a pre-existing secret will be returned"
                      }
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(parameters('useExisting'))]",
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2021-06-01-preview",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
                      "properties": {
                        "contentType": "[parameters('contentType')]",
                        "value": "[parameters('contentValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "secretUriWithVersion": {
                      "type": "string",
                      "metadata": {
                        "description": "The key vault URI linking to the new/updated secret"
                      },
                      "value": "[if(parameters('useExisting'), reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretName')), '2021-06-01-preview').secretUriWithVersion, reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretName')), '2021-06-01-preview').secretUriWithVersion)]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "emailServiceSendFromEmailAddressSecretDeploy",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultName": {
                    "value": "[parameters('keyVaultName')]"
                  },
                  "secretName": {
                    "value": "EmailServiceSendFromEmailAddress"
                  },
                  "contentValue": {
                    "value": "[parameters('sendFromEmailAddress')]"
                  },
                  "contentType": {
                    "value": "text/plain"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.31.92.45157",
                      "templateHash": "7647943469143824631"
                    },
                    "name": "Adds or updates a Key Vault secret",
                    "description": "Adds or updates a Key Vault secret",
                    "owner": "endjin"
                  },
                  "parameters": {
                    "secretName": {
                      "type": "string",
                      "metadata": {
                        "description": "Enter the secret name."
                      }
                    },
                    "contentType": {
                      "type": "string",
                      "defaultValue": "text/plain",
                      "metadata": {
                        "description": "Type of the secret"
                      }
                    },
                    "contentValue": {
                      "type": "securestring",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Value of the secret"
                      }
                    },
                    "keyVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the vault"
                      }
                    },
                    "useExisting": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "When true, a pre-existing secret will be returned"
                      }
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(parameters('useExisting'))]",
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2021-06-01-preview",
                      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
                      "properties": {
                        "contentType": "[parameters('contentType')]",
                        "value": "[parameters('contentValue')]"
                      }
                    }
                  ],
                  "outputs": {
                    "secretUriWithVersion": {
                      "type": "string",
                      "metadata": {
                        "description": "The key vault URI linking to the new/updated secret"
                      },
                      "value": "[if(parameters('useExisting'), reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretName')), '2021-06-01-preview').secretUriWithVersion, reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretName')), '2021-06-01-preview').secretUriWithVersion)]"
                    }
                  }
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'AcsEmailDeploy')]"
      ]
    }
  ],
  "outputs": {
    "domain": {
      "type": "string",
      "metadata": {
        "description": "The Azure managed domain."
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'AcsEmailDeploy'), '2022-09-01').outputs.domain.value]"
    },
    "sendFromEmailAddress": {
      "type": "string",
      "metadata": {
        "description": "The send-from email address for the Azure managed domain."
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'AcsEmailDeploy'), '2022-09-01').outputs.sendFromEmailAddress.value]"
    }
  }
}